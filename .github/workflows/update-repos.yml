name: Update Repositories

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-repos:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Update README with repositories
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import json
          import urllib.request
          import os
          import time

          # --- Configuration ---
          USERNAME = "dedbot365"

          # --- Helper Functions ---

          def get_top_languages(url, token):
              """Fetches language data and returns the top 3 as a string."""
              try:
                  headers = {'User-Agent': 'Python/3.8'}
                  if token:
                      headers['Authorization'] = f"Bearer {token}"
                  
                  # Fetch language breakdown
                  req = urllib.request.Request(url, headers=headers)
                  with urllib.request.urlopen(req) as response:
                      data = json.loads(response.read())
                      
                  if not data:
                      return "N/A"
                      
                  # Sort by usage (bytes) in descending order
                  sorted_langs = sorted(data.items(), key=lambda item: item[1], reverse=True)
                  
                  # Take top 3 keys
                  top_3 = [l[0] for l in sorted_langs[:3]]
                  return ", ".join(top_3)
              except Exception as e:
                  print(f"Error fetching languages for {url}: {e}")
                  return "N/A"

          def clean_description(text, max_length=60):
              """Truncates description to be short and sweet."""
              if not text:
                  return "No description"
              
              # Remove pipes (which break Markdown tables) and newlines
              clean_text = text.replace("|", "-").replace("\n", " ")
              
              # Truncate if too long
              if len(clean_text) > max_length:
                  return clean_text[:max_length].strip() + "..."
              return clean_text

          # --- Main Script ---

          print("Fetching repositories...")
          url = f"https://api.github.com/users/{USERNAME}/repos?per_page=100&sort=updated&direction=desc"
          
          try:
              token = os.environ.get("GITHUB_TOKEN")
              headers = {'User-Agent': 'Python/3.8'}
              if token:
                  headers['Authorization'] = f"Bearer {token}"
              
              req = urllib.request.Request(url, headers=headers)
              with urllib.request.urlopen(req) as response:
                  repos = json.loads(response.read())
          except Exception as e:
              print(f"Error fetching repos: {e}")
              exit(1)

          # Create markdown table header
          table = "| Repository | Description | Top Languages | Stars | Forks | Last Updated |\n"
          table += "|------------|-------------|---------------|-------|-------|--------------|\n"
          
          for repo in repos: 
              name = repo['name']
              repo_url = repo['html_url']
              
              # 1. Process Description (Short & Sweet)
              desc = clean_description(repo['description'])
              
              # 2. Process Languages (Top 3)
              langs_url = repo['languages_url']
              top_langs = get_top_languages(langs_url, token)
              
              stars = repo['stargazers_count']
              forks = repo['forks_count']
              updated = repo['updated_at'].split('T')[0]
              
              table += f"| [{name}]({repo_url}) | {desc} | {top_langs} | ‚≠ê {stars} | üî± {forks} | {updated} |\n"
              
              # Sleep briefly to respect GitHub API limits
              time.sleep(0.1)

          # Read current README
          readme_path = 'README.md'
          try:
              with open(readme_path, 'r', encoding='utf-8') as f:
                  content = f.read()
          except FileNotFoundError:
              print("README.md not found!")
              exit(1)
          
          def replace_section(content, start_marker, end_marker, new_text):
              start_idx = content.find(start_marker)
              end_idx = content.find(end_marker)
              
              if start_idx != -1 and end_idx != -1:
                  return (
                      content[:start_idx + len(start_marker)] +
                      "\n" + new_text + "\n" +
                      content[end_idx:]
                  )
              else:
                  print(f"Warning: Markers {start_marker}...{end_marker} not found.")
                  return content

          # Update sections
          content = replace_section(content, "", "", table)
          
          # Write updated README
          with open(readme_path, 'w', encoding='utf-8') as f:
              f.write(content)
          
          print("‚úÖ README updated successfully with Repositories!")
          
          PYTHON_SCRIPT

      - name: Commit and push if changed
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add README.md
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "docs: Auto-update repositories list [skip ci]"
            git push
          fi
